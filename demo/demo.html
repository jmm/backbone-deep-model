<!DOCTYPE html>

<html lang="en-US">

<head>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<title>Ancestor Change Demo</title>

</head>


<body>

<script type="text/javascript" src="../test/lib/underscore-1.3.1.js"></script>

<script type="text/javascript" src="../test/lib/backbone-0.9.2.js"></script>

<script type="text/javascript" src="../src/deep-model.js"></script>


<script type="text/javascript">

var logger = function ( event ) {

  return function ( model, options, path, pattern ) {

    console.log( event, arguments );

  };

};


var models = new (

  Backbone.Collection.extend( { model : Backbone.DeepModel } )

)( [

  { id : 1 },

  { id : 2 }

] );


models.forEach( function ( model ) {

  model.set( 'a', { b : { c : { d : { e : "whatever" } } } } );


  model.on( 'change:a.b.c.d.e', logger( 'change:a.b.c.d.e' ) );

  // The following lines accomplish nothing, ordinarily

  model.on( 'change:a.b.c', logger( 'change:a.b.c' ) );

  model.on( 'change:a.b.*', logger( 'change:a.b.*' ) );

  model.on( 'change:a', logger( 'change:a' ) );

} );


/*

Version that works by overriding trigger. This uses the stock
backbone-deep-model.

*/

models.get( 1 ).set( 'version', 'trigger override' );

models.get( 1 ).trigger = function ( event ) {

  var patt, args;

  var trigger = this.constructor.__super__.trigger;


  var return_val = trigger.apply( this, arguments );


  if (

    ( patt = /^change:((a\.b\.([^.]+))(?:\..+)?)/ ) &&

    ( patt.last_result = patt.exec( event ) )

  ) {

    args = [

      'change:' + patt.last_result[2],

      this,

      arguments[3],

      patt.last_result[1],

      patt

    ];


    trigger.apply( this, args );


    args[0] = "change:a.b.*";

    trigger.apply( this, args );


    args[0] = "change:a";

    trigger.apply( this, args );

  }


  return return_val;

};




/*

Version that relies on modified backbone-deep-model.

*/

models.get( 2 ).set( 'version', 'API' );

// Proxy to trigger()

models.get( 2 ).onChangeAncestor(

  /^(a\.b\.([^.]+))/,

  function ( model, options, path, pattern ) {

    this.trigger(

      'change:' + pattern.last_result[1], model, options, path, pattern

    );


    this.trigger( 'change:a', model, options, path, pattern );

  }

);


// Just call the change handler directly

models.get( 2 ).onChangeAncestor( /^(a\.b\.([^.]+))/, logger( 'change:a.b.*' ) );




models.forEach( function ( model ) {

  console.group( model.get( 'version' ) );

  model.set( 'a.b.c.d.e', "blah" );

  console.groupEnd();

} );

</script>

</body>

</html>
